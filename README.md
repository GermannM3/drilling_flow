# DrillFlow - Платформа для распределения заказов на бурение

## Архитектура

Проект построен на основе следующих компонентов:

1. **Telegram Bot** (Основной интерфейс)
   - Обработка команд пользователей
   - Управление заказами
   - Система рейтингов
   - Интеграция с платежами

2. **FastAPI Backend**
   - REST API для админ-панели
   - Обработка webhook'ов от Telegram
   - Интеграция с внешними сервисами

3. **Nginx**
   - Reverse proxy
   - Статические файлы
   - SSL/TLS
   - Кэширование

## Мониторинг и поддержка

### Проверка здоровья
- `/health` - общий статус
- `/bot-health` - статус Telegram бота
- Логи в `/app/logs/`

### Метрики
- Prometheus метрики
- Grafana дашборды
- Алерты через Telegram

## Развертывание

Проект автоматически развертывается на Timeweb Cloud:
1. Push в main ветку
2. Автоматическая сборка Docker образа
3. Деплой на germannm3-drilling-flow-12c3.twc1.net

DrillFlow — автоматизированная платформа для распределения заказов на бурение между подрядчиками на основе геолокации, рейтинга и загрузки.

## Основные возможности

### Telegram-бот
- Регистрация и верификация подрядчиков
  - Проверка документов
  - Модерация профилей
  - Защита от мультиаккаунтинга
- Управление профилем подрядчика
  - Настройка радиуса работы (до 100 км)
  - Установка максимальной загрузки
  - Управление уведомлениями
- Система распределения заказов
  - Автоматический подбор по геолокации
  - Приоритезация по рейтингу
  - Таймер подтверждения (5 минут)
- Рейтинговая система
  - Начисление баллов за выполнение
  - Штрафы за нарушения
  - Влияние на приоритет заказов

### Клиентский интерфейс
- Оформление заказов
  - Выбор типа услуг
  - Геолокация
  - Загрузка фото/описания
- Отслеживание статуса
- Система оплаты
  - Предоплата 20%
  - Возврат средств
- Отзывы и оценки

### Админ-панель
- Управление пользователями
  - Верификация подрядчиков
  - Блокировка нарушителей
  - Корректировка рейтингов
- Мониторинг заказов
  - Ручное распределение
  - Обработка конфликтов
- Аналитика и отчетность
  - Статистика и графики
  - Экспорт данных

## Технический стек

### Бэкенд
- Python 3.11+
- Django 4.2+
- Django REST Framework
- Celery для асинхронных задач
- Redis для кэширования

### Безопасность
- SSL/TLS шифрование
- DDoS-защита
- Антифрод система
- Резервное копирование

### Интеграции
- Telegram Bot API
- Google Maps Geocoding API
- Платежные системы:
  - Система быстрых платежей (СБП)
  - YooMoney
  - Stripe
- Антифрод: ip-api.com

## Установка и запуск

### Через Docker
```bash
# Клонирование репозитория
git clone https://github.com/GermannM3/drilling_flow.git
cd drilling_flow

# Запуск через Docker Compose
docker-compose up -d
```

### Локальная установка
```bash
# Создание виртуального окружения
python -m venv .venv
source .venv/bin/activate  # Linux/macOS
.venv\Scripts\activate     # Windows

# Установка зависимостей
pip install -r requirements.txt

# Настройка окружения
cp .env.example .env
# Отредактируйте .env файл

# Миграции и запуск
python manage.py migrate
python manage.py runserver
```

## Документация
- [Руководство разработчика](docs/developer-guide.md)
- [API документация](docs/api.md)
- [Архитектура проекта](docs/architecture.md)

## Лицензия
MIT License 

# DrillFlow API

FastAPI приложение для управления буровыми работами.

## Лицензии и правовая информация

### Яндекс Карты
Приложение использует сервисы Яндекс Карт на условиях [лицензионного соглашения](https://yandex.ru/legal/maps_api/).

При использовании карт необходимо:
- Размещать ссылку на условия использования
- Показывать копирайт "© Яндекс Карты"
- Не превышать лимиты бесплатного использования

## Развертывание

### Рабочие окружения

Продакшен: https://germannm3-drilling-flow-12c3.twc1.net
IP: 92.255.110.28

### Требования
- Docker
- PostgreSQL
- Redis

### Переменные окружения
Создайте файл `.env` со следующими переменными:

```env
# База данных
POSTGRES_DB=drillflow
POSTGRES_USER=postgres
POSTGRES_PASSWORD=your_password
DATABASE_URL=postgresql://postgres:your_password@db:5432/drillflow

# Redis
REDIS_URL=redis://redis:6379/0

# Безопасность
SECRET_KEY=your_secret_key
ALGORITHM=HS256

# API ключи
GOOGLE_MAPS_API_KEY=your_google_maps_key
TELEGRAM_BOT_TOKEN=your_bot_token
```

### Запуск
```bash
# Сборка
docker build -t drilling-flow -f Dockerfile.prod .

# Запуск
docker run -d -p 8001:8001 --env-file .env drilling-flow
```

## Telegram Bot

Бот является основным интерфейсом взаимодействия с пользователями. Он обеспечивает:

### Для клиентов:
- Оформление заказов на бурение
- Отслеживание статуса заказа
- Связь с подрядчиком
- Оплату услуг
- Оставление отзывов

### Для подрядчиков:
- Регистрацию и верификацию
- Получение заказов
- Управление профилем
- Просмотр рейтинга
- Получение оплаты

### Команды бота:
- /start - Начало работы
- /help - Справка
- /profile - Профиль пользователя
- /order - Создать заказ
- /status - Статус текущих заказов
- /support - Связь с поддержкой

### Мониторинг:
- Автоматическая проверка здоровья бота
- Логирование всех действий
- Уведомления администраторов о проблемах
- Метрики производительности

### Развертывание:
1. Убедитесь, что установлен токен бота в .env:
   ```
   TELEGRAM_TOKEN=your_bot_token
   ```
2. Бот автоматически запускается при деплое
3. Проверить статус можно по адресу:
   ```
   https://germannm3-drilling-flow-12c3.twc1.net/bot-health
   ``` 

# DrillFlow Telegram Бот

Telegram бот для управления буровыми работами и автоматизации процессов.

## Содержание

- [Быстрый старт](#быстрый-старт)
- [Установка](#установка)
- [Локальное тестирование](#локальное-тестирование)
- [Структура проекта](#структура-проекта)
- [API бота](#api-бота)
- [Инструменты для тестирования](#инструменты-для-тестирования)

## Быстрый старт

Для быстрой установки и запуска используйте скрипт `setup.js`:

```bash
node setup.js
```

Скрипт выполнит следующие действия:
1. Проверит наличие файла `.env` и создаст его, если необходимо
2. Установит все необходимые зависимости
3. Спросит, хотите ли вы запустить сервер сразу
4. Отобразит справку с доступными командами

## Установка

1. Клонируйте репозиторий:
```bash
git clone https://github.com/yourusername/drill-flow-bot.git
cd drill-flow-bot
```

2. Установите зависимости:
```bash
npm install
```

3. Настройте файл .env в корне проекта:
```
# Токен Telegram бота
TELEGRAM_TOKEN=your_bot_token_here

# URL для вебхука в продакшене
WEBHOOK_URL=https://your-domain.vercel.app/api/webhook

# Порт для локального сервера
PORT=3000

# Режим разработки для отображения подробных ошибок
NODE_ENV=development
```

## Локальное тестирование

### Подготовка к запуску

1. Установите необходимые зависимости:
   ```
   npm install express body-parser dotenv
   ```

2. В корне проекта находится файл `.env`, который содержит токен бота и другие настройки.

### Запуск локального сервера

1. Запустите локальный сервер командой:
   ```
   node local_test_bot.js
   ```

2. Сервер запустится на порту 3000 и будет готов принимать запросы.

### Тестирование бота

Для тестирования бота можно использовать два метода:

#### Метод 1: Использование PowerShell-скрипта

1. Откройте новое окно PowerShell (сервер должен быть запущен в другом окне)
2. Запустите скрипт тестирования:
   ```
   .\test_bot.ps1
   ```
3. Выберите команду из меню для отправки боту

#### Метод 2: Ручная отправка запросов через curl

Примеры команд для отправки запросов:

- Команда `/start`:
  ```
  curl -X POST -H "Content-Type: application/json" -d '{"update_id":123456789,"message":{"message_id":123,"from":{"id":1234567,"first_name":"Тест","username":"testuser"},"chat":{"id":1234567,"first_name":"Тест","username":"testuser","type":"private"},"date":1679000000,"text":"/start"}}' http://localhost:3000/webhook
  ```

- Команда "📋 Профиль":
  ```
  curl -X POST -H "Content-Type: application/json" -d '{"update_id":123456789,"message":{"message_id":123,"from":{"id":1234567,"first_name":"Тест","username":"testuser"},"chat":{"id":1234567,"first_name":"Тест","username":"testuser","type":"private"},"date":1679000000,"text":"📋 Профиль"}}' http://localhost:3000/webhook
  ```

## Структура проекта

- `local_test_bot.js` - Локальный сервер для тестирования
- `api/telegram_webhook_handler.js` - Основной обработчик вебхука
- `test_bot.ps1` - PowerShell-скрипт для интерактивного тестирования

## Токены бота

- Для продакшена: `7554540052:AAEvde_xL9d85kbJBdxPu8B6Mo4UEMF-qBs`
- Для локального тестирования: `7293247588:AAH5qQkNUmhoTzZ-_MSw0gS4BKlSTAW5qdM`

## Команды бота

- `/start` - Запуск бота
- 📋 Профиль - Просмотр профиля пользователя
- 📦 Заказы - Просмотр заказов
- 🔄 Обновить статус - Изменение статуса
- 📊 Статистика - Просмотр статистики
- 💰 Доход - Финансовая информация
- ⚙️ Настройки - Настройки профиля
- 🔄 Подписка - Управление подпиской
- 💳 Тестовый платеж - Тестирование платежей
- ❓ Помощь - Получение справки

## Развертывание на Vercel

1. Установите Vercel CLI:
```bash
npm install -g vercel
```

2. Авторизуйтесь:
```bash
vercel login
```

3. Развертывание на Vercel:
```bash
vercel deploy --prod
```

4. После развертывания, установите вебхук:
```bash
python scripts/set_webhook.py
```

---

© 2024 DrillFlow 